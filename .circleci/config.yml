# WARNING: DO NOT EDIT THIS FILE DIRECTLY!!!
# See the README.md in this directory.

# IMPORTANT: To update Docker image version, please first update
# https://github.com/pytorch/ossci-job-dsl/blob/master/src/main/groovy/ossci/pytorch/DockerVersion.groovy and
# https://github.com/pytorch/ossci-job-dsl/blob/master/src/main/groovy/ossci/caffe2/DockerVersion.groovy,
# and then update DOCKER_IMAGE_VERSION at the top of the following files:
# * cimodel/data/pytorch_build_definitions.py
# * cimodel/data/caffe2_build_definitions.py
# And the inline copies of the variable in
# * verbatim-sources/job-specs-custom.yml
#   (grep for DOCKER_IMAGE)

version: 2.1

executors:
  windows-gpu-prototype:
    machine:
      resource_class: windows.gpu.small.prototype
      image: windows-server-2019-nvidia:201908-28
      shell: bash.exe

##############################################################################
# Job specs
##############################################################################
jobs:
  pytorch_windows_build:
    executor: windows-gpu-prototype
    environment:
      BUILD_ENVIRONMENT: "pytorch-win-ws2016-cuda9-cudnn7-py3"
      SCCACHE_BUCKET: "ossci-compiler-cache"
      CUDA_VERSION: "10"
      USE_CUDA: "1"
    steps:
      - checkout
      - run:
          name: Build
          no_output_timeout: "90m"
          command: |
            set -ex
            set +x
            export AWS_ACCESS_KEY_ID=${CIRCLECI_AWS_ACCESS_KEY_FOR_SCCACHE_S3_BUCKET_V4}
            export AWS_SECRET_ACCESS_KEY=${CIRCLECI_AWS_SECRET_KEY_FOR_SCCACHE_S3_BUCKET_V4}
            set -x
            choco install -y curl 7zip
            choco install cmake --installargs 'ADD_CMAKE_TO_PATH=User'
            .jenkins/pytorch/win-build.sh
# PR jobs pr builds
workflows:
  build:
    jobs:
      - pytorch_windows_build
