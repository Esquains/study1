# WARNING: DO NOT EDIT THIS FILE DIRECTLY!!!
# See the README.md in this directory.

# IMPORTANT: To update Docker image version, please first update
# https://github.com/pytorch/ossci-job-dsl/blob/master/src/main/groovy/ossci/pytorch/DockerVersion.groovy and
# https://github.com/pytorch/ossci-job-dsl/blob/master/src/main/groovy/ossci/caffe2/DockerVersion.groovy,
# and then update DOCKER_IMAGE_VERSION at the top of the following files:
# * cimodel/data/pytorch_build_definitions.py
# * cimodel/data/caffe2_build_definitions.py
# And the inline copies of the variable in
# * verbatim-sources/job-specs-custom.yml
#   (grep for DOCKER_IMAGE)

version: 2.1

executors:
  windows-gpu-prototype:
    machine:
      resource_class: windows.gpu.small.prototype
      image: windows-server-2019-nvidia:201908-28
      shell: bash.exe

##############################################################################
# Job specs
##############################################################################
jobs:
  pytorch_windows_build:
    executor: windows-gpu-prototype
    environment:
      BUILD_ENVIRONMENT: "pytorch-win-ws2016-cuda9-cudnn7-py3"
      SCCACHE_BUCKET: "ossci-compiler-cache"
      CUDA_VERSION: "10"
      USE_CUDA: "1"
    steps:
      - checkout
      - run:
          name: Install VC2017
          no_output_timeout: "60m"
          command: |
            set -x
            choco install -y curl 7zip
            cd C:/
            # Install Visual Studio 2015
            export EXE=vs_2015_community.exe
            curl https://s3.amazonaws.com/ossci-windows/$EXE --output $EXE
            ./$EXE /q /norestart /InstallSelectableItems NativeLanguageSupport_Group
            # Install Visual Studio 2017
            # NOTE: before this bug https://devtalk.nvidia.com/default/topic/1027209/cuda-9-0-does-not-work-with-the-latest-vs-2017-update/?offset=1 is fixed, we should use VS 2017 15.4.5 version
            export EXE=vs_2017_15.4.5_Community.exe
            curl https://s3.amazonaws.com/ossci-windows/$EXE --output $EXE
            ./$EXE --norestart --wait --add Microsoft.VisualStudio.Component.VC.Tools.x86.x64 --add Microsoft.VisualStudio.Component.VC.DiagnosticTools --add Microsoft.VisualStudio.Component.Windows10SDK.16299.Desktop --add Microsoft.VisualStudio.Component.VC.CMake.Project --add Microsoft.VisualStudio.Component.VC.ATL --add Microsoft.VisualStudio.Component.VC.140

      - run:
          name: Build
          no_output_timeout: "90m"
          command: |
            set -ex
            set +x
            export AWS_ACCESS_KEY_ID=${CIRCLECI_AWS_ACCESS_KEY_FOR_SCCACHE_S3_BUCKET_V4}
            export AWS_SECRET_ACCESS_KEY=${CIRCLECI_AWS_SECRET_KEY_FOR_SCCACHE_S3_BUCKET_V4}
            set -x

            choco install cmake --installargs 'ADD_CMAKE_TO_PATH=User'
            .jenkins/pytorch/win-build.sh
# PR jobs pr builds
workflows:
  build:
    jobs:
      - pytorch_windows_build
