# WARNING: DO NOT EDIT THIS FILE DIRECTLY!!!
# See the README.md in this directory.

# IMPORTANT: To update Docker image version, please first update
# https://github.com/pytorch/ossci-job-dsl/blob/master/src/main/groovy/ossci/pytorch/DockerVersion.groovy and
# https://github.com/pytorch/ossci-job-dsl/blob/master/src/main/groovy/ossci/caffe2/DockerVersion.groovy,
# and then update DOCKER_IMAGE_VERSION at the top of the following files:
# * cimodel/data/pytorch_build_definitions.py
# * cimodel/data/caffe2_build_definitions.py
# And the inline copies of the variable in
# * verbatim-sources/job-specs-custom.yml
#   (grep for DOCKER_IMAGE)

version: 2.1

executors:
  windows-gpu-prototype:
    machine:
      resource_class: windows.gpu.small.prototype
      image: windows-server-2019-nvidia:201908-28
      shell: bash.exe

  windows-cuda:
    machine:
      resource_class: l1.large
      image: windows-server-2019-nvidia:edge
      shell: bash.exe
##############################################################################
# Job specs
##############################################################################
jobs:
  pytorch_windows_build:
    executor: windows-cuda
    environment:
      BUILD_ENVIRONMENT: "pytorch-win-ws2019-cuda10-cudnn7-py3"
      SCCACHE_BUCKET: "ossci-compiler-cache"
      CUDA_VERSION: "10"
      USE_CUDA: "1"
    steps:
      - checkout
      - run:
          name: Build
          no_output_timeout: "90m"
          command: |
            set -ex
            set +x
            export AWS_ACCESS_KEY_ID=${MINGBO_AWS_KEY_ID}
            export AWS_SECRET_ACCESS_KEY=${MINGBO_AWS_SECRET_KEY}
            set -x
            choco install cmake --installargs 'ADD_CMAKE_TO_PATH=User'
            choco install -y 7zip curl awscli
            # choco upgrade -y visualstudio2019community
            pushd ..
            curl -O https://ossci-windows.s3.amazonaws.com/cudnn-10.1-windows10-x64-v7.6.4.38.zip
            7z x cudnn-10.1-windows10-x64-v7.6.4.38.zip -ocudnn
            cp -r  cudnn/cuda/* "C:/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v10.1/"
            popd
            .jenkins/pytorch/win-build.sh
  pytorch_windows_test:
    executor: windows-gpu-prototype
    environment:
      BUILD_ENVIRONMENT: "pytorch-win-ws2019-cuda10-cudnn7-py3"
      SCCACHE_BUCKET: "ossci-compiler-cache"
      CUDA_VERSION: "10"
      # USE_CUDA: "1"
    steps:
      - checkout
      - run:
          name: Test
          no_output_timeout: "90m"
          command: |
            set -e
            set +x
            export AWS_ACCESS_KEY_ID=${MINGBO_AWS_KEY_ID}
            export AWS_SECRET_ACCESS_KEY=${MINGBO_AWS_SECRET_KEY}
            set -x
            # choco install cmake --installargs 'ADD_CMAKE_TO_PATH=User'
            choco install -y 7zip curl awscli
            .jenkins/pytorch/win-test.sh

workflows:
  build_and_test:
    jobs:
      - pytorch_windows_build
      - pytorch_windows_test:
          requires:
            - pytorch_windows_build

