# @generated DO NOT EDIT MANUALLY
# Template is at:    .github/templates/linux_ci_workflow.yml.j2
# Generation script: .github/scripts/generate_ci_workflows.py
name: Linux CI (pytorch-libtorch-linux-xenial-cuda10.2-cudnn7-py3.6-gcc7)

on:
  # TODO: Enable pull_request builds when we can verify capacity can be met by auto-scalers
  push:
    branches:
      - master
      - release/*
  workflow_dispatch:

env:
  BUILD_ENVIRONMENT: pytorch-libtorch-linux-xenial-cuda10.2-cudnn7-py3.6-gcc7
  DOCKER_IMAGE_BASE: 308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda10.2-cudnn7-py3-gcc7
  SCCACHE_BUCKET: ossci-compiler-cache-circleci-v2
  TORCH_CUDA_ARCH_LIST: 5.2
  IN_CI: 1
  # Used for custom_opertor, jit_hooks, custom_backend, see .jenkins/pytorch/build.sh
  CUSTOM_TEST_ARTIFACT_BUILD_DIR: build/custom_test_artifacts
  ALPINE_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/tool/alpine"

concurrency:
  group: pytorch-libtorch-linux-xenial-cuda10.2-cudnn7-py3.6-gcc7-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs:
  calculate-docker-image:
    if: ${{ github.repository_owner == 'pytorch' }}
    runs-on: linux.2xlarge
    needs: []
    env:
      DOCKER_BUILDKIT: 1
    timeout-minutes: 90
    outputs:
      docker_image: ${{ steps.calculate-tag.outputs.docker_image }}
    steps:
      - name: no op
        run: echo "FAKE CALCULATE DOCKER"

  build:
    runs-on: linux.2xlarge
    needs: [calculate-docker-image, ]
    env:
      DOCKER_IMAGE: ${{ needs.calculate-docker-image.outputs.docker_image }}
      JOB_BASE_NAME: pytorch-libtorch-linux-xenial-cuda10.2-cudnn7-py3.6-gcc7-build
    steps:
      - name: Do nothing, pseudo build step
        run: echo "YAY BUILD STEP DONE"
