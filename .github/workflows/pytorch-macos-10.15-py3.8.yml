# @generated DO NOT EDIT MANUALLY
# Template is at:    .github/templates/macos_ci_workflow.yml.j2
# Generation script: .github/scripts/generate_macos_ci_workflows.py
name: MacOS CI (pytorch-macos-10.15-py3.8)

on:
  pull_request:

env:
  BUILD_ENVIRONMENT: pytorch-macos-10.15-py3.8
  SCCACHE_BUCKET: ossci-compiler-cache-circleci-v2

jobs:
  build:
    runs-on: macos-10.15
    steps:
      - name: Clone pytorch/pytorch
        uses: actions/checkout@v2
        with:
          path: pytorch
          submodules: recursive
      - name: Download and set up sccache
        run: |
          set -e
          sudo curl --retry 3 https://s3.amazonaws.com/ossci-macos/sccache_v2.15 --output /usr/local/bin/sccache
          sudo chmod +x /usr/local/bin/sccache
      - name: Run build
        working-directory: pytorch/
        run: |
          sudo xcode-select -r

          # reload aws creds
          sccache --stop-server || echo "server already stopped"
          sccache --start-server

          export IN_CI=1
          sudo xcode-select -s /Applications/Xcode_12.0.1.app
          chmod a+x .jenkins/pytorch/macos-build.sh
          .jenkins/pytorch/macos-build.sh
      - name: Archive artifacts into zip
        working-directory: pytorch/
        run: |
          zip -r artifacts.zip *
      - uses: actions/upload-artifact@v2
        name: Store PyTorch Build Artifacts
        with:
          name: pytorch-macos-10.15-py3.8
          retention-days: 30
          if-no-files-found: error
          path:
            pytorch/artifacts.zip
  test:
    runs-on: macos-10.15
    needs:
      - build
    steps:
      - name: Install test dependencies
        run: |
          brew install libomp
      - name: Clone pytorch/pytorch
        uses: actions/checkout@v2
        with:
          path: pytorch
          submodules: recursive
      - uses: actions/download-artifact@v2
        name: Download PyTorch Build Artifacts
        with:
          name: pytorch-macos-10.15-py3.8
          path: pytorch/artifacts.zip
      
      - name: Unzip artifacts
        working-directory: pytorch/
        run: |
          unzip -o artifacts.zip
      - name: test torch
        working-directory: pytorch/
        run: |
          python3 --version
          python --version
          python3 -c 'import torch'
      - name: Run tests
        working-directory: pytorch/
        env:
          BUILD_ENVIRONMENT: pytorch-macos-10.15-py3.8-test
        run: |
          set -e
          export IN_CI=1

          chmod a+x .jenkins/pytorch/macos-test.sh
          .jenkins/pytorch/macos-test.sh
