syntax = "proto2";

import "caffe2/proto/caffe2.proto";

package torch;

enum ProtoVersion {
  _START_VERSION = 0;
  IR_VERSION_NEWEST = 0x0000000000000101;
}

message ParameterDef {
  // whether we compute the gradient for the parameter
  optional bool require_gradient = 1;
  // if keep_in_opt is true, we keep the this parameter
  // no matter whether the model has any dependency on
  // this parameter
  optional bool keep_in_opt = 2;

  // tensor type parameter
  caffe2.TensorProto tensor = 3;
  // objects other than tensors will be added here
}

message MethodDef {
  // method name
  // by default, we follow the naming convention below:
  //   1) forward --> main method
  //   2) init --> init method
  optional string name = 1; // method name

  // static graph
  optional caffe2.NetDef graph = 2;
  // method is represented as torch script
  optional string torch_script = 3;

  // inputs and outputs are inferred from graph or script
}

message ModuleDef {
  repeated ModuleDef submodules = 1;

  // We suppose to store the modules in one of the following format:
  //   - methods (static graph or torch script)
  //   - pickle
  //   - cpp_arena
  repeated MethodDef methods = 2;
  // because the old pickle modules may not be supported by torch_script,
  // have to stored as pickle_arena at this moment.
  optional bytes pickle_arena = 3;
  // should be exposed by the Class Archive, so user can save
  // module specific data which cannot be store in the graph or torch_script
  optional bytes cpp_arena = 4;

  // the parameters of this module
  repeated ParameterDef parameters = 5;

  // the names of inputs and outputs of the module are inferred
  // from the main method.
}

message ModelDef {
  optional int64 ir_version = 1;

  // main module of the model
  optional ModuleDef main_module = 2;

  // to distinguish whether exported from c2 or torch
  optional string producer_name = 3;

  // put build version here
  optional string producer_version = 4;

  optional string name = 5;

  // metadata
  //   - debug_info - string
  // for MetaNetDef:
  //   - project - string
  //   - model_class - string
  //   - internal_version - string
  //   - predictor_type - string
  //   - predictor_id - string
  //   - execute_plan - string
  //   - applicationSpecificInfo
  //   - publish_time - string
  repeated caffe2.Argument annotations = 6;

}
